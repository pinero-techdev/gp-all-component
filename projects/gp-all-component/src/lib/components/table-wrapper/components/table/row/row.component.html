<!-- Start cells for checkbox or radius selection -->

<td *ngIf="(builder.isSelectionMode | memo: model:'checkbox')">
  <p-tableCheckbox [value]="row"></p-tableCheckbox>
</td>

<td *ngIf="(builder.isSelectionMode | memo: model:'radius')">
  <p-tableRadioButton [value]="row"></p-tableRadioButton>
</td>

<!-- End cells for checkbox or radius selection -->

<!-- Start main cell body -->
<td *ngFor="let column of (builder.getColumns | memo: model)">
  <!--Render main cell template depending on logic -->
  <ng-container
    [ngTemplateOutlet]="
      (isDynamic || (builder.isEditableColumn | memo: model:column.field)) && isEditing
        ? editableCell
        : (builder.isCustomColumn | memo: model:column.field)
        ? customCell
        : defaultCell
    "
    [ngTemplateOutletContext]="{ $implicit: column }"
  ></ng-container>
</td>

<!-- Template for custom cell -->
<ng-template #customCell let-column>
  <ng-container
    [ngTemplateOutlet]="builder.getCustomColumn | memo: model:column.field"
    [ngTemplateOutletContext]="{ $implicit: row, editing: isEditing }"
  ></ng-container>
</ng-template>

<!-- Template for default cell -->
<ng-template #defaultCell let-column>
  {{ builder.getRowValue(column, row, fields) }}
</ng-template>

<!-- Template for editable cell -->
<ng-template #editableCell let-column>
  <ng-container
    *ngIf="!isDynamic && (builder.isEditableColumn | memo: model:column.field)"
    [ngTemplateOutlet]="builder.getEditableColumn | memo: model:column.field"
    [ngTemplateOutletContext]="{ $implicit: row }"
  ></ng-container>

  <ng-container *ngIf="isDynamic">
    <gp-dynamic-field
      [field]="builder.getFieldById(column.field, fields)"
      [value]="builder.getDataFieldById(column.field, fields, row)"
      [relatedFields]="relatedFields ? relatedFields[column.field] : null"
      (onChange)="onDynamicFieldChange($event)"
    ></gp-dynamic-field>
  </ng-container>
</ng-template>

<!-- End main cell body -->

<!-- Start edition action cells -->

<!-- Render edition action cell template depending on logic -->
<td *ngIf="(builder.isEditable | memo: model)" class="ui-buttonpane-narrow">
  <ng-container
    [ngTemplateOutlet]="isEditing ? editing : editable"
    [ngTemplateOutletContext]="{ $implicit: row }"
  ></ng-container>
</td>

<!-- Template for actions while not editing -->
<ng-template #editable>
  <gp-button
    [type]="'icon'"
    [disabled]="disableAction"
    icon="pi pi-pencil"
    (onClickEvent)="startEdition()"
  ></gp-button>
  <gp-button
    [type]="'icon'"
    icon="pi pi-trash"
    [disabled]="disableAction"
    (onClickEvent)="deleteRow()"
    [severity]="'danger'"
  ></gp-button>
</ng-template>

<!-- Template for actions while editing -->
<ng-template #editing let-row>
  <gp-button
    [type]="'icon'"
    icon="pi pi-check"
    (onClickEvent)="persistEdition()"
    [disabled]="disableSave && isDynamic"
  >
  </gp-button>
  <gp-button
    [type]="'icon'"
    icon="pi pi-times"
    (click)="cancelEdition()"
    [severity]="'danger'"
  ></gp-button>
</ng-template>

<!-- End edition action cells -->
